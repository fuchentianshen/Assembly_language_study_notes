### 1.移位指令

- 逻辑左移 SHL OPR,CNT

  (1)将寄存器或内存单元中的数据向左移位

  (2)将最后移出的一位写入CF中

  (3)最低位用0补充

  > 移动位数大于1时必须用cl
  >
  > 惯常用法 : 将X逻辑左移一位，相当于执行X=X*2 ; 右移一位，相当于执行X=X/2

- 逻辑右移 SHR OPR,CNT

- 算术左移 SAL OPR,CNT

- 带进位循环左移 RCL OPR,CNT

- 循环左移 ROL OPR,CNT

- 循环右移 ROR OPR,CNT

- 算术右移 SAR OPR,CNT

- 带进位循环右移 RCR OPR,CNT

### 2.操作显存数据

屏幕上的内容=显存中的数据

显示缓冲区的结构：

要显示符号的ASCIl	低位字节
显示属性字节	高位字节
![image-20230830134243711](https://cdn.jsdelivr.net/gh/fuchentianshen/Typora_cloudimg/img/image-20230830134243711.png)

### 3.描述内存单元的标号

### 4.数据的直接定址表

用查表的方法解决问题

利用表，在两个数据集合之间建立一种映射关系，用查表的方法根据给出的数据得到其在另一集合中的对应数据

> 优点:
> 	算法清晰和简洁
>
> ​	加快运算速度
>
> ​	使程序易于扩充

### 5.代码的直接定址表

用查表的方式，通过依据数据，直接计算出所要找的元素的位置

类似于C语言的switch()函数

### 6.中断及其处理

### 7.编制中断处理程序

要求：中断子程序应该存放在内存的确定位置——我们要重新找个地方，不破坏系统。

事实：在操作系统之上使用计算机，所有的硬件资源都在操作系统的管理之下，应该向操作系统申请获得存放中断子程序的内存。

简便方案：绕过操作系统，直接在找到一块别的程序不会用到的内存区，将中断子程序传送到其中即可。

利用中断向量表中的空闲单元来存放我们的程序。估计出，中断子程序的长度不可能超过256个字节，就选用从0000:0200至0000:02FF的256个字节的空间。

**do0安装程序的实现**

> 设置ds:si指向源地址cs:do0
>
> 设置es:di指向目的地址 0:200h
>
> 设置cx为传输长度
>
> 设置传输方向为正
>
> rep movsb

```assembly
mov ax,cs
mov ds,ax
mov si,offset do0
mov ax,0
mov es,ax
mov di,200h
mov cx,do0部分代码长度
cld
rep movsb
```

do0部分代码长度：

```assembly
do0:中断子程序
	mov ax,4c00h
	int 21h
do0end:nop
```

```assembly
mov cx,offset do0end-offset do0
```

![image-20230907185228788](https://cdn.jsdelivr.net/gh/fuchentianshen/Typora_cloudimg/img/image-20230907185228788.png)

## 8.由int指令引发的中断

> CPU内部产生的中断信息
>
> - 除法错误
> - 单步执行
> - 执行into指令
> - 执行int 指令

int格式:int n,n为中断类型码

功能:引发中断过程

CPU 执行int n指令，相当于引发一个n号中断的中断过程，执行过程如下：

1. 取中断类型码n ;
2. 标志寄存器入栈，IF= 0，TF=0;
3. CS、IP入栈;
4. (IP)= (n*4)，(CS)=(n *4+2)

中断处理程序的常规的步骤

1. 保存用到的寄存器
2. 处理中断
3. 恢复用到的寄存器
4. 用 iret 指令返回

## 9.BIOS和DOS中断处理

**BIOS——基本输入输出系统**

- BIOS，是在系统板的ROM中存放着一套程序

  容量:8KB

  地址:从FE000H开始

- BIOS中的主要内容

  1. 硬件系统的检测和初始化程序
  2. 外部中断和内部中断的中断例程
  3. 用于对硬件设备进行I/O操作的中断例程
  4. 其他和硬件系统相关的中断例程

![image-20230914200807448](https://cdn.jsdelivr.net/gh/fuchentianshen/Typora_cloudimg/img/image-20230914200807448.png)

**DOS中断**



![image-20230915193601819](https://cdn.jsdelivr.net/gh/fuchentianshen/Typora_cloudimg/img/image-20230915193601819.png)

**BIOS和DOS中断例程的安装过程**

![image-20230915200929562](https://cdn.jsdelivr.net/gh/fuchentianshen/Typora_cloudimg/img/image-20230915200929562.png)

## 10.端口的读写

**访问端口的方法**
例: 

```assembly
in al, 60h;从60h号端口读入一个字节二执行时与总线相关的操作
```

执行时与总线相关的操作

1. CPU通过地址线将地址信息60h发出
2. CPU通过控制线发出端口读命令，选中端口所在的芯片，并通知要从中读取数据
3. 端口所在的芯片将60h端口中的数据通过数据总线送入CPU。

**端口的读写指令示例**
对0~255以内的端口进行读写，端口号用立即数给出

```assembly
in al,20h;从20h端口读入一个字节
out 21h,al;往21h端口写入一个字节
```

对256~65535的端门进行读写时，端号放在dx中

```assembly
mov dx,3f8h;将端口号3f8送入dx
in al,dx;从3f8h端口读入一个字节
out dx,al;向3f8h端口写入一个字节
```

## 11.操作作CMOS RAM芯片

**CMOS RAM 芯片**

1. 包含一个实时钟和一个有128个存储单元的RAM存储器

2. 128 个字节的 RAM 中存储：内部实时钟、系统配置信息相关的程序(用于开机时配置系统信息 )

3. CMOS RAM 芯片靠电池供电，关机后其内部的实时钟仍可正常工作，RAM 中的信息不丢失。

4. 该芯片内部有两个端口，端口地址为70h和71h，CPU 通过这两个端口读写CMOS RAM。

   70h地址端口，存放要访问的CMOS RAM单元的地址

   71h数据端口，存放从选定的单元中读取的数据，或要写入到其中的数据。

5. 读取CMOS RAM的两个步聚
   1. 将要读取的单元地址送入70h地址端口
   2. 从数据端口71h读出指定单元的内容。

![image-20230916122834715](https://cdn.jsdelivr.net/gh/fuchentianshen/Typora_cloudimg/img/image-20230916122834715.png)

![image-20230916122904798](https://cdn.jsdelivr.net/gh/fuchentianshen/Typora_cloudimg/img/image-20230916122904798.png)

```assembly
assume cs:code
code segment
start:mov al,8
    out 70h,al
    in al,71h;取得月份数据

    mov ah,al
    mov cl,4
    shr ah,cl
    and al,00001111b;分离月份的十、个位

    add ah,30h
    add al,30h;转换为ASCII码

    mov bx,0b800h
    mov es,bx
    mov byte ptr es:[160*12+40*2],ah
    mov byte ptr es:[160*12+40*2+2],al;显示
    mov ax,4c00h
    int 21h

code ends
end start
```

## 12.外设连接与中断

中断分为外中断和内中断

**外中断：由外部设备发生的事件引起的中断**

- 可屏蔽中断

  - 可屏蔽中断是CPU 可以不响应的外中断。

  - CPU 是否响应可屏蔽中断，要看标志寄存器的IF 位的设置。

  - 当CPU 检测到可屏蔽中断信息时：

    如果IF=1，则CPU 在执行完当前指令后响应中断，引发中断过程

    如果IF=0，则不响应可屏蔽中断。

- 不可屏蔽中断

  - 不可屏蔽中断是CPU 必须响应的外中断。
  - 当CPU 检测到不可屏蔽中断信息时，则在执行完当前指令后，立即响应，引发中断过程。
  - 对于8086CPU 不可屏蔽中断的中断类型码固定为2。

- 几乎所有由外设引发的外中断，都是可屏蔽中断，比如键盘输入、打印机请求。

- 不可屏蔽中断在系统中有必须处理的紧急情况发生时用来通知CPU 的中断信息。

![image-20230916163048082](https://cdn.jsdelivr.net/gh/fuchentianshen/Typora_cloudimg/img/image-20230916163048082.png)

## 13.PC机键盘的处理过程

> 按下一个键时的操作
> 	开关接通，该芯片就产生一个扫描码，扫描码说明了按下的键在键盘上的位置。
> 	扫描码被送入主板上的相关接口芯片的寄存器中，该寄存器的端口地址为60H

> 松开按下的键时的操作
>
> ​	产生一个扫描码，扫描码说明了松开的键在键盘上的位置。
>
> ​	松开按键时产生的扫描码也被送入60H 端口中。

> 扫描码——长度为一个字节的编码
> 	按下一个键时产生的扫描码——通码，通码的第7 位为 0
>
> ​	松开一个键时产生的扫描码——断码，断码的第7位为 1



> 一个键盘输入用一个字单元存放，高位字节存放扫描码，低位字节存放字符码。

## 14.定制键盘输入处理

关于中断处理程序入口地址面对的问题

- 要将中断向量表中的int 9中断例程的入口地址改为自编的中断处理程序的入口地址。
- 在新中断处理程序中调用原来的int 9中断例程，还需要是原来的int 9 中断例程的地址。
- 解决方法：保存原中断例程入口地址
- 将原来int 9中断例程的偏移地址和段地址保存在ds:[0]和ds:[2]单元中，在需要调用原来的int 9中断例程时候，到 ds:[0]、ds:[2] 找到

## 15.改写中断例程的方法

## 16.用中断响应外设

> int 9h将键盘输入存入缓冲或改变状态字



> BIOS提供了int 16h 中断例程供程序员调用，以完成键盘的各种操作
>
> 功能：从键盘缓冲区中读取一个键盘输入，并且将其从缓冲区中删除

**int 16h 中断例程 0 号功能的实现过程:**

1. 检测键盘缓冲区中是否有数据；
2. 没有则继续做第1 步；
3. 读取缓冲区第一个字单元中的键盘输入；
4. 将读取的扫描码送入ah，ASCII 码送入al；
5. 将己读取的键盘输入从缓冲区中删除。

> B1OS 的int 9 中断例程和int 16h 中断例程是一对相互配合的程序，int 9 中断例程向键盘缓冲区中写入，int 16h 中断例程从缓冲区中读出。
> 它们写入和读出的时机不同，int 9 中断例程在有键按下的时候向键盘缓冲区中写入数据；而int 16h 中断例程是在应用程序对其进行调用的时候，将数据从键盘缓冲区中读出。

---

![image-20230917192302150](https://cdn.jsdelivr.net/gh/fuchentianshen/Typora_cloudimg/img/image-20230917192302150.png)

---

## 17.读写磁盘

![image-20230918190227542](https://cdn.jsdelivr.net/gh/fuchentianshen/Typora_cloudimg/img/image-20230918190227542.png)

**用BIOS int 13h对磁盘进行读操作**
入口参数：
(ah)=2（2表示读扇区）
(al)=读取的扇区数
(ch)=磁道号，(cl)=扇区号
(dh)=磁头号（对于软盘即面号，一个面用一个磁头来读写）
(dl)=驱动器号：软驱从0开始，0：软驱A，1：软驱B；硬盘从80h开始，80h：硬盘C，81h：硬盘D
es:bx指向接收从扇区读入数据的内存区
返回参数：
操作成功：(ah)=0，(al)=读入的扇区数
操作失败：(ah)=出错代码

**用BIOS int 13h对磁盘进行写操作**
入口参数：
(ah)=3（3表示写扇区）
(al)=写入的扇区数
(ch)=磁道号，(cl)=扇区号
(dh)=磁头号（对于软盘即面号）
(dl)=驱动器号：软驱从0开始，0：软驱A，1：软驱B；硬盘从80h开始，80h：硬盘C，81h：硬盘D
es:bx指向将写入磁盘的数据
返回参数：
操作成功：(ah)=0，(al)=写入的扇区数
操作失败：(ah)=出错代码

**DOS中断对磁盘文件的支持——int 21H**

## 18.让计算机“唱歌”

**与"计算机唱歌"有关的硬件及控制**

- 8253 芯片(定时/计数器)的设置

```assembly
mov al,0b6h ;8253初始化
out 43h,al ;43H是8253芯片控制口的端口地址
mov dx,12h
mov ax,34dch
div word ptr [si] ;计算分频值,赋给ax, [si]中存放声音的频率值。
out 42h, al ;先送低8位到计数器，42h是8253芯片通道2的端口地址
mov al, ah
out 42h, al ;后送高8位计数器
```

- 设置8255芯片(并行I/O), 控制扬声器的开/关

```assembly
in al,61h ;读取8255 B端口原值
mov ah,al ;保存原值
or al,3 ;使低两位置1，以便打开开关
out 61h,al ;开扬声器, 发声
... ;延时，保持时间
...
mov al, ah
out 61h, al;恢复扬声器端口原值
```

